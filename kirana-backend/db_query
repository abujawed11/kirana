CREATE DATABASE IF NOT EXISTS kirana_db;

USE kirana_db;


CREATE TABLE IF NOT EXISTS users (
  user_id VARCHAR(10) NOT NULL,                      -- e.g. USR0001
  name VARCHAR(100) NOT NULL,
  email VARCHAR(191) NULL,
  phone VARCHAR(15) NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role ENUM('customer','seller','admin') NOT NULL DEFAULT 'seller',
  is_active TINYINT(1) NOT NULL DEFAULT 1,
  last_login_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (user_id),
  UNIQUE KEY uq_users_phone (phone),
  UNIQUE KEY uq_users_email (email)
);



CREATE TABLE IF NOT EXISTS otp_codes (
  otp_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id VARCHAR(10) NULL,                          -- FK to users
  phone VARCHAR(15) NULL,
  email VARCHAR(191) NULL,
  code CHAR(6) NOT NULL,
  purpose ENUM('signup','login','reset') NOT NULL,
  channel ENUM('sms','email') NOT NULL,
  attempts TINYINT UNSIGNED NOT NULL DEFAULT 0,
  max_attempts TINYINT UNSIGNED NOT NULL DEFAULT 5,
  is_used TINYINT NOT NULL DEFAULT 0,
  expires_at DATETIME NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  sent_at DATETIME NULL,

  PRIMARY KEY (otp_id),
  CONSTRAINT fk_otp_user FOREIGN KEY (user_id)
    REFERENCES users(user_id)
    ON DELETE SET NULL ON UPDATE CASCADE,
  KEY idx_otp_phone (phone),
  KEY idx_otp_email (email),
  KEY idx_otp_expiry (expires_at)
)